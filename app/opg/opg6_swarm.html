<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Docker Workshop - Swarm</title>

    <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../style.css">

    <script src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#navigation').load('../navbar.html');

            /*$('.task').each(function() {
                var $id = $(this).attr("id");
                var dataElem = {"task": $id};
                $.ajax({
                    url: '/check',
                    data: { task: $id }
                }).done(function(data) {
                    $('#' + $id).append('<div>'+data+'</div>');
                });
            });*/
        });
    </script>
</head>

<body>

<div class="nav-container">
    <div id="navigation"></div>
</div>

<div class="container">
    <h1>Oppgave 6 - Lage clustere med Docker Swarm</h1>
    <p>
        En Docker Swarm er et cluster av docker-machines, der <b>noder</b> blir styrt av en eller flere <b>Swarm manager(e)</b>.
        Dette er en form for abstraksjon, og sett utenfra er en swarm manager ekvivalent med en normal docker machine. Forskjellen
        er at manageren automatisk kan fordele containere på de nodene som til enhver tid har mest ledig kapasitet, og gjør
        det lettere å skalere etter behov. En swarm kan enkelt utvides med flere noder når man trenger mer ytelse.
    </p>

    <h2>a)</h2>
    <p>
        Bruk docker-machine til å lage en Swarm med minst 3 noder og en Swarm Manager. For å sette en swarm-maskin som aktiv
        brukes kommandoen 'eval "$(docker-machine env --swarm &lt;navn-på-maskin&gt;)"'.
        Sett swarm-manageren som aktiv, og bruk deretter "docker info" for å se dens status, med bl.a. hvor mange noder den inneholder,
        nodenes IP, hvor mange containere hver node kjører osv.
    </p>
    <div class="alert alert-info">
        <b>NB:</b> Noter ned Swarm-tokenen etter at den har blitt generert, ettersom den trengs for å interagere med swarmen.
        Denne token-en kan også finnes ved å kjøre 'docker info' med swarm-masteren satt som aktiv i Docker Machine.
    </div>

    <h2>b)</h2>
    <p>
        For å teste at swarmen vår fungerer kan vi starte opp en noen containere. Bruk <a href="https://hub.docker.com/explore/">Docker Hub</a>
        eller 'docker search' for å finne ferdige images på programmer, og kjør de med swarm-masteren satt som aktiv maskin.
        Med 'docker ps' vises da kjørende containere for alle noder i swarmen.
    </p>
    Merk:
    <ul>
        <li>Mange containere vil avslutte med en gang når de kjøres med 'docker run -d', og derfor ikke vil vises.</li>
        <li>
            Hver av docker maskinene må ha tilgang til imaget for å kunne kjøre en container av det. Om man vil kjøre lokale
            imager distribuert i en swarm må man derfor bygge det for hver maskin. Alternativt kan man benytte programmer
            for å administrere images og containere, som f.eks Universal Control Plane (ikke gratis).
        </li>
    </ul>
    Prøv for eksempel å kjøre:
    <ul>
        <li>Nginx</li>
        <li>Redis</li>
        <li>Mongo</li>
        <li>Httpd</li>
    </ul>

    <p>
        For øvrig er det mulig å stoppe alle containere i en swarm med én kommando. Dersom swarm-masteren er aktiv, vil kommandoen
        'docker ps -q' liste ut kjørende containere i hele swarm'en. Ved da å kombinere dette til 'docker stop $(docker ps -q)'
    </p>

    <!--div id="fremgang">
        <h2>Fremgang</h2>
        <div id="8a" class="task">a) </div>
        <div id="8b" class="task">b) </div>
    </div-->

    <h2>Bonusoppgave</h2>
    <p>
        Grunnen til at dere ikke brukte workshopens egen applikasjon i b), er at images ikke automatisk distribueres til
        hele swarmen. En Swarm-master distribuerer kun <strong>kommandoene</strong> til nodene, ikke selve containerene,
        og nodene må derfor ha korrekt image tilgjengelig for å kunne starte opp en container.
    </p>
    <p>
        Ved første forsøk på å kjøre en container blir en node (tilfeldig?) valgt, og deretter vil alle
        senere forsøk også styres til samme node. Forskjellen fra b), er at vår egen applikasjon så langt kun har vært et
        lokalt image, mens de øvrige har kommet fra repositoryet Docker Hub. Ved å tilgjengeliggjøre et image på Docker Hub,
        eller et annet konfigurert repository, så vil egen applikasjon kunne oppføre seg på samme måte.
    </p>
        Dermed:
    <ul>
        <li>Opprett konto på Docker Hub.</li>
        <li>Bruk docker login til å logge på kontoen.</li>
        <li>Tag imaget med tagnavn &lt;konto&gt;/&lt;image-navn&gt;</li>
        <li>Bruk docker push til å laste opp og tilgjengeliggjøre imaget</li>
        <li>Kjør på samme måte som i b), men angi nå full tag heller enn lokalt image-navn. Husk å mappe portnummer.</li>
        <li>Gjenta, og se med docker ps at det nå kjøres containere på flere noder.</li>
    </ul>
    <p>
        Ved å aksessere &lt;node-ip&gt;:8080/test kan man verifisere installasjonene. Nå kjører altså applikasjonen i et
        cluster, men for å kunne drive lastbalansering vil man naturligvis måtte trenge en lastbalanserer i forkant. Her
        kan man for eksempel bruke Apache eller Nginx (dette er ikke ment å være en del av oppgaven, dog).
    </p>

    <h2>Nyttige lenker</h2>
    <ul>
        <li><a href="https://docs.docker.com/swarm/provision-with-machine/">Provisioning a Swarm Cluster with Docker Machine</a></li>
        <li><a href="https://docs.docker.com/swarm/">Docker Docs - Swarm</a></li>
    </ul>

</div>


</body>
</html>